// ============================================================================
// File: rpc_request.fbs
// Namespace: fbs.cuda.ipc.api
// ---------------------------------------------------------------------------
// RPC Request tables for CUDA IPC, using common definitions.
// ============================================================================

include "common.fbs";

namespace fbs.cuda.ipc.api;

// ---------------------------------------------------------------------------
// CUDA IPC Request Tables
// ---------------------------------------------------------------------------

table GetAvailableGPUsRequest {}

table GetAllocatedTotalBufferCountRequest {
  gpu_uuid: UUID (required); // Target GPU UUID
}

table GetAllocatedTotalBytesRequest {
  gpu_uuid: UUID (required); // Target GPU UUID
}

table GetMaxAllocationBytesRequest {
  gpu_uuid: UUID (required); // Target GPU UUID
}

// ---------------------------------------------------------------------------
// CUDA Buffer Creation Request
// ---------------------------------------------------------------------------
// Represents a request to create a CUDA buffer on a specific GPU.
// This request is typically sent by a client to the CUDA IPC service.
// ---------------------------------------------------------------------------
table CreateCUDABufferRequest {
  gpu_uuid: UUID (required);    // UUID of the target GPU device where the buffer should be created (response includes cuda_device_id)
  size: uint64;                 // Size of the buffer in bytes to be allocated on the GPU
  expiration: ExpirationOption; // Expiration policy for the buffer, defined in common.fbs
  zero_buffer: bool;            // Write zeros to the new buffer cudaMemset(ptr, 0, size)
}

// ---------------------------------------------------------------------------
// CUDA Buffer Retrieval Request
// ---------------------------------------------------------------------------
table GetCUDABufferRequest {
  buffer_id: UUID (required);  // Buffer ID (UUID) to query and return raw gpu memory pointer
}

// ---------------------------------------------------------------------------
// Notify Buffer Usage Completion Request
// ---------------------------------------------------------------------------
table NotifyDoneRequest {
  buffer_id: UUID (required);  // Buffer ID (UUID) to notify access completed
  access_id: uint32;           // Access ID - included in CudaBufferResponse
}

// ---------------------------------------------------------------------------
// CUDA Buffer Free Request
// ---------------------------------------------------------------------------
table FreeCUDABufferRequest {
  buffer_id: UUID (required);   // Buffer ID (UUID) to free
}

// ---------------------------------------------------------------------------
// Union of all possible RPC request types
// ---------------------------------------------------------------------------
union RPCRequest {
  GetAvailableGPUsRequest,
  GetAllocatedTotalBufferCountRequest,
  GetAllocatedTotalBytesRequest,
  GetMaxAllocationBytesRequest,
  CreateCUDABufferRequest,
  GetCUDABufferRequest,
  NotifyDoneRequest,
  FreeCUDABufferRequest
}

// ---------------------------------------------------------------------------
// Root type for RPC request messages
// ---------------------------------------------------------------------------
table RPCRequestMessage {
  request: RPCRequest (required);
}
root_type RPCRequestMessage;
